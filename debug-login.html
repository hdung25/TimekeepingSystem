<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Debug Login & Security</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #222;
            color: #0f0;
        }

        .box {
            border: 1px solid #444;
            padding: 10px;
            margin-bottom: 10px;
        }

        input {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px;
        }

        button {
            cursor: pointer;
            padding: 5px 10px;
        }

        .error {
            color: #f00;
        }

        .success {
            color: #0f0;
            font-weight: bold;
        }

        .step {
            margin: 5px 0;
            border-bottom: 1px dashed #444;
            padding-bottom: 5px;
        }
    </style>
    <script src='https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js'></script>
    <script src='https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js'></script>
    <script src='https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js'></script>
    <script src='js/firebase-config.js'></script>
</head>

<body>
    <h1>üïµÔ∏è Debug Login & Security Rules</h1>

    <div class="box">
        <h3>1. Test Credentials</h3>
        Username: <input type="text" id="u" value="admin"> <br><br>
        Password: <input type="text" id="p" value="Hdung.25"> <br><br>
        <button onclick="runTest()">‚ñ∂Ô∏è RUN DIAGNOSTIC</button>
    </div>

    <div class="box" id="logs">
        <div>Ready...</div>
    </div>

    <script>
        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = 'step ' + type;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('logs').appendChild(div);
        }

        async function runTest() {
            document.getElementById('logs').innerHTML = '';
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            const email = `${u}@tuduytre.com`.toLowerCase();

            log("STEP 1: Checking Firebase Config...");
            if (!firebase.apps.length) { log("‚ùå Firebase not initialized!", 'error'); return; }
            log(`‚úÖ Firebase Project: ${firebase.app().options.projectId}`, 'success');

            log("STEP 2: Attempting Auth (SignIn)...");
            log(`Target: ${email}`);

            try {
                await firebase.auth().signOut(); // Clear prev
                const cred = await firebase.auth().signInWithEmailAndPassword(email, p);
                log(`‚úÖ Auth SUCCESS! UID: ${cred.user.uid}`, 'success');

                // STEP 3
                log("STEP 3: Testing Firestore Permission (Read Users)...");
                log("Querying: collection('users').where('username' == '" + u + "')");

                try {
                    const snapshot = await firebase.firestore().collection('users')
                        .where('username', '==', u)
                        .limit(1)
                        .get();

                    if (snapshot.empty) {
                        log("‚ö†Ô∏è Read Success but NO documents found! (User data missing?)", 'error');
                    } else {
                        log(`‚úÖ Read SUCCESS! Found Doc ID: ${snapshot.docs[0].id}`, 'success');
                        log("üéâ CONCLUSION: System is working perfectly. The issue might be cache or old code in main.js.", 'success');
                    }

                } catch (dbErr) {
                    log(`‚ùå Read FAILED: ${dbErr.message}`, 'error');
                    log("üëâ Diagnosis: Auth worked, but Firestore Rules blocked the read.", 'error');
                }

            } catch (authErr) {
                log(`‚ùå Auth FAILED: ${authErr.message}`, 'error');
                if (authErr.code === 'auth/wrong-password') log("üëâ Diagnosis: Password is WRONG.");
                if (authErr.code === 'auth/user-not-found') log("üëâ Diagnosis: User does not exist in Auth.");
            }
        }
    </script>
</body>

</html>